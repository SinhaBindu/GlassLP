@model UserViewModel
@{
	ViewData["Title"] = Model != null && !string.IsNullOrEmpty(Model.Id) ? "Edit User" : "Create User";
}
<div class="row">
	<div class="col-12">
		<h4 class="main-title">Users Management</h4>
		<ul class="app-line-breadcrumbs mb-3">
			<li class="">
				<a class="f-s-14 f-w-500" href="">
					<span>
						Master
					</span>
				</a>
			</li>
			<li class="">
				<a class="f-s-14 f-w-500" href="Users/Index">
					<span>
						Users Management
					</span>
				</a>
			</li>
			<li class="active">
				<a class="f-s-14 f-w-500" href="#">@(Model != null && !string.IsNullOrEmpty(Model.Id) ? "Update User" : "Add New User")</a>
			</li>
		</ul>
	</div>
</div>
<div class="row">
	<div class="col-12">
		<div class="card">
			@* <div class="card-header d-flex align-items-center">
				<h5 class="mb-0"></h5>
			</div> *@
			<div class="card-body">
				<form class="app-form" method="post" enctype="multipart/form-data" id="addForm">
					@if (Model != null && !string.IsNullOrEmpty(Model.Id))
					{
						@Html.HiddenFor(m => m.Id)
					}
					<div class="row">
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.UserName, new { @class = "form-label" })
								@Html.EditorFor(m => m.UserName, new { htmlAttributes = new { @class = "required form-control", @maxlength = "20" } })
								<div>@Html.ValidationMessageFor(m => m.UserName, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.Email, new { @class = "form-label" })
								@Html.EditorFor(m => m.Email, new { htmlAttributes = new { @class = "required form-control", @type = "email", @maxlength = "100" } })
								<div>@Html.ValidationMessageFor(m => m.Email, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.Name, new { @class = "form-label" })
								@Html.EditorFor(m => m.Name, new { htmlAttributes = new { @class = "form-control required", @maxlength = "200" } })
								<div>@Html.ValidationMessageFor(m => m.Name, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.PhoneNumber, new { @class = "form-label" })
								@Html.EditorFor(m => m.PhoneNumber, new { htmlAttributes = new { @class = "form-control numbersOnly required", @maxlength = "10" } })
								<div>@Html.ValidationMessageFor(m => m.PhoneNumber, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.Role, new { @class = "form-label" })
								@Html.DropDownListFor(m => m.Role, Model?.RoleList ?? new List<SelectListItem>(), "-- Select Role --", new { @class = "required form-control" })
								<div>@Html.ValidationMessageFor(m => m.Role, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.Password, new { @class = "form-label" })
								@Html.EditorFor(m => m.Password, new { htmlAttributes = new { @class = "form-control required", @type = "password", @maxlength = "100", @placeholder = Model != null && !string.IsNullOrEmpty(Model.Id) ? "Leave empty to keep current password" : "", @id = "Password" } })
								<div>@Html.ValidationMessageFor(m => m.Password, "", new { @class = "text-danger" })</div>
								@if (Model != null && !string.IsNullOrEmpty(Model.Id))
								{
									<small class="text-muted">Leave empty to keep current password</small>
								}
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.ConfirmPassword, new { @class = "form-label" })
								@Html.EditorFor(m => m.ConfirmPassword, new { htmlAttributes = new { @class = "form-control required", @type = "password", @maxlength = "100", @id = "ConfirmPassword" } })
								<div>@Html.ValidationMessageFor(m => m.ConfirmPassword, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.DistrictIds, new { @class = "form-label" })
								@Html.DropDownListFor(m => m.DistrictIds, Model.DistrictList ?? new List<SelectListItem>(), "Select", new { @class = "form-control", multiple = "multiple" })
								<div>@Html.ValidationMessageFor(m => m.DistrictIds, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="mb-3">
								@Html.LabelFor(m => m.BlockId, new { @class = "form-label" })
								@Html.DropDownListFor(m => m.BlockId, new List<SelectListItem>(), "Select Block", new { @class = "form-control" })
								<div>@Html.ValidationMessageFor(m => m.BlockId, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						<div class="col-md-4" >
							<div class="mb-3">
								@Html.LabelFor(m => m.CLFId, new { @class = "form-label" })
								@Html.DropDownListFor(m => m.CLFId, new List<SelectListItem>(), "Select CLF", new { @class = "form-control" })
								<div>@Html.ValidationMessageFor(m => m.CLFId, "", new { @class = "text-danger" })</div>
							</div>
						</div>
						
						<div class="col-md-3">
							<div class="mb-3">
								@Html.LabelFor(m => m.IsActive, new { @class = "form-label d-block" })
								<div class="form-check form-switch">
									@Html.CheckBoxFor(m => m.IsActive, new { @class = "form-check-input" })
									<label class="form-check-label" for="IsActive">Active</label>
								</div>
							</div>
						</div>
						<div class="col-12">
							<div class="text-end">
								<a asp-action="Index" class="btn btn-secondary b-r-22 me-2">Cancel</a>
								<button class="btn btn-primary b-r-22" type="submit">
									@(Model != null && !string.IsNullOrEmpty(Model.Id) ? "Update" : "Submit")
								</button>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	@{
		await Html.RenderPartialAsync("_ValidationScriptsPartial");
	}
	<script>
		$(document).ready(function () {
			// Set default password for new users
			var hasDistrictList = @(Model.DistrictList != null ? "true" : "false");
			if (hasDistrictList)
			{
				debugger;
				GetJSBlocks("BlockId", $('#DistrictIds').val());
				setTimeout(function () {
					$("#BlockId")
						.val('@(Model.BlockId ?? 0)')
						.trigger('change');
					GetJSFederations("CLFId", $('#DistrictIds').val(), $("#BlockId").val());
					setTimeout(function () {
						$("#CLFId").val("@Model.CLFId").trigger('change');
					}, 300);

				}, 500);
			}
			else
				GetJSDistricts("DistrictIds");
			$('#DistrictIds').select2();
			// District change event
			$("#DistrictIds").change(function () {
				debugger;
				var districtId = $(this).val();
				GetJSBlocks("BlockId", districtId);
				$("#BlockId").empty().append('<option value="">Select</option>');
				$("#CLFId").empty().append('<option value="">Select</option>');
			});
			// Block change event
			$("#BlockId").change(function () {
				var districtId = $("#DistrictIds").val();
				var blockId = $(this).val();
				if (districtId && blockId) {
					//GetJSPanchayats("PanchayatId", districtId, blockId);
					GetJSFederations("CLFId", districtId, blockId);
				}
			});

			// Post form data
			$('#addForm').on('submit', function (e) {
				e.preventDefault();
				//var form = $('#addForm')[0];
				var ids = $('#DistrictIds').val();
				var formData = new FormData($('#addForm')[0]);
				formData.delete("DistrictIds");
				ids.forEach(x => formData.append("DistrictIds", x));
				//var formData = new FormData(form);
				if (!$('#addForm').valid()) {
					return; // Invalid form, stop submission
				}
				$.ajax({
					url: '/Users/Create',
					type: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function (response) {
						if (response.isSuccess === true) {
							toastr.success(response.message);
							setTimeout(function () {
								window.location.href = '/Users/Index';
							}, 1500);
						} else {
							if (response.validationErrors && response.validationErrors.length > 0) {
								var errorMsg = response.validationErrors.join('<br>');
								toastr.error(errorMsg);
							} else {
								toastr.error(response.message || 'An error occurred.');
							}
						}
					},
					error: function (xhr) {
						var errorMsg = 'Error occurred while saving user.';
						if (xhr.responseJSON && xhr.responseJSON.message) {
							errorMsg = xhr.responseJSON.message;
						}
						toastr.error(errorMsg);
					}
				});
			});
		});

	</script>
}

